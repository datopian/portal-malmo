# Accessibility checks (developer guide)

This project includes **automated accessibility checks** using **[Cypress](https://docs.cypress.io/app/get-started/why-cypress) + [Axe](https://github.com/dequelabs/axe-core)**.

The goal is to:

* Catch common accessibility issues early
* Fail PRs when regressions are introduced
* Keep the setup simple and repeatable across projects

---

## What runs automatically

On every **pull request** and **push**:

* Routes are generated automatically
* Cypress opens each route
* Axe scans the page using **WCAG 2.2 AA rules**
* The build fails if any violation is found

---

## How routes are generated

Routes are generated by:

```
scripts/generate-routes.mjs
```

This script creates:

```
public/__routes.json
```

### Static routes

The script:

* Scans the **Next.js App Router** (`src/app` or `app`)
* Looks for `page.tsx / page.jsx / page.js`

Example output:

```
/
/groups
/search
/organizations
```

---

## CKAN dataset routes (dynamic pages)

To also scan dataset pages, the script fetches **one dataset from CKAN**.

Using:

* `NEXT_PUBLIC_DMS` (CKAN base URL)
* `package_search` API

It adds:

* `/@org-name/dataset-name`
* `/@org-name/dataset-name/resource-id` (first resource only)

This ensures:

* Dataset pages are covered
* Resource pages are covered
* Tests stay fast and deterministic

---

## How accessibility tests work

Tests live in:

```
cypress/e2e/a11y-all-pages.cy.ts
```

For each generated route:

* Cypress visits the page
* Axe is injected
* WCAG rules are executed:

  * `wcag2aa`
  * `wcag21aa`
  * `wcag22aa`

If a violation is found:

* The test fails
* Detailed logs are printed:

  * Rule ID (e.g. `color-contrast`)
  * Impact level
  * CSS selectors
  * HTML snippets

---

## Example failure output

You may see errors like:

* `color-contrast`
* `aria-required-attr`
* `label`

This usually points to:

* Low contrast text
* Missing labels
* Invalid ARIA usage

The console output shows **exact selectors** so the issue can be fixed quickly.

---

## Running locally

### Run everything

```bash
npm run test:e2e
```

### Generate routes only

```bash
npm run routes:gen
```

---

## Environment variables

| Variable                          | Purpose                            |
| --------------------------------- | ---------------------------------- |
| `NEXT_PUBLIC_DMS`                 | CKAN base URL                      |

---

## CI behavior

In CI:

* Tests run automatically on PRs
* Test status is visible in GitHub
* PRs cannot be merged if accessibility checks fail

---

## Report example
![alt text](report.png)

---

## Summary

* Routes are generated automatically
* Dataset + resource pages included
* WCAG 2.2 AA rules enforced
* Fails fast on PRs


## References

- Cypress documentation: https://docs.cypress.io/
- cypress-axe: https://github.com/component-driven/cypress-axe
- axe-core: https://github.com/dequelabs/axe-core
- WCAG 2.2 (W3C): https://www.w3.org/TR/WCAG22/